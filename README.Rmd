---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mlstats <img src="man/img/sticker.png" align="right" height="138" /></a>

<!-- badges: start -->
[![R-CMD-check](https://github.com/felixdidi/mlstats/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/felixdidi/mlstats/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The **mlstats** package provides tools for conducting multilevel analyses, such as centering variables to compute random effects within-between (REWB) models or creating publication-ready descriptive tables, including within-group and between-group correlations, as well as intraclass correlation coefficients (ICCs). The package supports frequentist (using `lme4`) and Bayesian (using `brms`) estimation.

## Installation

You can install the development version of mlstats from GitHub:

```r
# install.packages("pak")
pak::pak("felixdidi/mlstats")
```

## Multilevel Descriptives

### Easy Defaults

The `mldesc()` function has defaults that make it easy to compute descriptive statistics for multilevel data. It outputs basic descriptives, ICCs, as well as within-group and between-group correlations for a set of variables, given a grouping variable (e.g., person ID). If desired, the `within_between_correlations()` function computes only a correlation matrix without additional descriptives.

```{r data, echo = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(stringr)
data <-
  read.csv(
    "https://files.de-1.osf.io/v1/resources/m8pu3/providers/osfstorage/6935c4c2bd3315c47d2a1952?view_only=9321c19e5fd34eff87ff934ac2e0c8af"
  ) |>
  mutate(
    person = id,
    self_control = sc_m_pre,
    goal_conflict = goal_conf,
    disconnection = disco_b,
    procrastination = procra,
    .keep = "none"
  )
```

```{r example}
library(mlstats)

vars <- c(
  "self_control",
  "goal_conflict",
  "disconnection",
  "procrastination"
)

data |>
  mldesc(
    group = "person",
    vars = vars
  )
```

### Customizable Options

There are several options to customize the output:

- **Weight by group size**: By default, the group means, standard deviations, and between-group correlations are weighted by group size. This can be disabled by setting `weight = FALSE` (e.g., so that each person in the sample contributes equally to the overall mean and the between-person correlations).
- **Remove leading zeros**: By default, `mldesc()` removes leading zeros from decimal numbers to comply with APA formatting guidelines. This can be disabled by setting `remove_leading_zero = FALSE`.
- **Flip correlation matrix**: By default, within-group correlations are displayed above the diagonal and between-group correlations below the diagonal. This can be changed by setting `flip = TRUE`.
- **Significance stars**: By default, one star is added to all correlation coefficients with *p* < .05. By setting `significance = "detailed"`, this can be changed to one star for *p* < .05, two stars for *p* < .01, and three stars for *p* < .001.

```{r no-weight-example}
data |>
  mldesc(
    group = "person",
    vars = vars,
    weight = FALSE,
    remove_leading_zero = FALSE,
    flip = TRUE,
    significance = "detailed"
  )
```


### Pretty Printing

The `mldesc()` function supports various print-methods that can be accessed by passing its output to `print()`. All printing methods allow customization of the `table_title`, `correlation_note`, `significance_note`, and `note_text`. Whereas the default print method prints to the console, a `gt` object is returned when setting `format = "gt"`.

All outputs are designed to look great by default — however, users can further customize the output by modifying the resulting `tibble` and `gt` objects (for customization of `gt` tables, see its documentation [here](https://gt.rstudio.com/)). To reproduce Table 1 from Klingelhoefer et al. (2025) more closely, we can adjust the output by selecting relevant columns, replacing `NA`s with dashes, and adding footnotes:

```{r gt-example, eval = FALSE}
data |>
  mldesc(group = "person", vars = vars, significance = "detailed") |>
  select(-n_obs, -range) |>
  mutate(across(everything(), ~ str_replace(.x, "NA", "–"))) |>
  mutate(across(any_of(c("m", "sd")), ~ if_else(variable == "Disconnection", "–", .x))) |>
  mutate(variable = case_when(variable == "Self control" ~ "Self-control<sup>c</sup>", variable == "Goal conflict" ~ "Goal-conflict", variable == "Disconnection" ~ "Disconnection<sup>d</sup>", variable == "Procrastination" ~ "Procrastination")) |>
  print(
    format = "gt",
    table_title = "Descriptive statistics, within- and between-person correlations for central variables",
    correlation_note = "Within-person correlations depicted above, between-person correlations below the diagonal.",
    note_text = "<i>Note</i>. <i>N</i> = 237, <i>T</i> = 12,408."
  ) |>
  gt::tab_source_note(source_note = gt::html("<sup>c</sup> Self-control was measured as a trait, and no within-person correlation is available.")) |>
  gt::tab_source_note(source_note = gt::html("<sup>d</sup> Digital disconnection was operationalized as a binary variable and does not have a mean or standard deviation.")) |>
  gt::fmt_markdown(columns = variable)
```

```{r gt-example-rendered, echo = FALSE, message = FALSE}
data |>
  mldesc(
    group = "person",
    vars = vars,
    significance = "detailed"
  ) |>
  select(-n_obs, -range) |>
  mutate(across(everything(), ~ str_replace(.x, "NA", "–"))) |>
  mutate(across(
    any_of(c("m", "sd")),
    ~ if_else(variable == "Disconnection", "–", .x)
  )) |>
  mutate(
    variable = case_when(
      variable == "Self control" ~ "Self-control<sup>c</sup>",
      variable == "Goal conflict" ~ "Goal-conflict",
      variable == "Disconnection" ~ "Disconnection<sup>d</sup>",
      variable == "Procrastination" ~ "Procrastination"
    )
  ) |>
  print(
    format = "gt",
    table_title = "Descriptive statistics, within- and between-person correlations for central variables",
    correlation_note = "Within-person correlations depicted above, between-person correlations below the diagonal.",
    note_text = "<i>Note</i>. <i>N</i> = 237, <i>T</i> = 12,408."
  ) |>
  gt::tab_source_note(
    source_note = gt::html(
      "<sup>c</sup> Self-control was measured as a trait, and no within-person correlation is available."
    )
  ) |>
  gt::tab_source_note(
    source_note = gt::html(
      "<sup>d</sup> Digital disconnection was operationalized as a binary variable and does not have a mean or standard deviation."
    )
  ) |>
  gt::fmt_markdown(columns = variable) |>
  gt::gtsave("man/img/gt-example.png")
```

![](man/img/gt-example.png)

### Pipe-Friendly Output

Although the main purpose of the package is to enable user-friendly creation of publication-ready tables, the output of both `mldesc()` and the underlying `within_between_correlations()` are tibbles with vectors of class `mlstats_stat` (or short, `mls`). These tibbles can be used for subsequent calculations by casting the contents to useful types such as `numeric` (this will remove significance stars and other formatting). For example, the output of `within_between_correlations()` can be used to identify the largest within-person correlation in the dataset:

```{r extract-example, warning = FALSE}
cors <-
  data |>
  within_between_correlations(
    group = "person",
    vars = vars
  )

cors |>
  mutate(across(-variable, as.numeric)) |> 
  rename_with(~ cors$variable, .cols = -variable) |>
  pivot_longer(-variable) |>
  rename(v1 = variable, v2 = name) |>
  group_by(v1) |>
  mutate(type = if_else(row_number() > which(is.na(value)), "wp", "bp")) |>
  ungroup() |>
  filter(type == "wp") |> 
  filter(value == max(value))
```

## Centering

The package also facilitates centering of variables for further use with the `decompose_within_between()` function. This centering approach is commonly used in multilevel modeling to separate within-group and between-group variance components (Enders & Tofighi, 2007). The decomposed variables are particularly useful for Random Effects Within-Between (REWB) models (Bell et al., 2019), which allow the estimation of distinct within-group and between-group effects.

```{r decompose-example}
data |>
  rename(disco = disconnection) |>
  decompose_within_between(
    group = "person",
    vars = "disco"
  ) |>
  select(person, matches("disco"))
```

## Bayesian Estimation

If desired, the package also supports Bayesian estimation via `brms`, providing credible intervals instead of *p*-values through `bayes_mldesc()` and `bayes_within_between_correlations()`. In addition to the parameters available in the frequentist functions, users must specify the credible interval width (`ci`) and a folder to save the fitted models (`folder`).

Note that the Bayesian functions may take a considerable amount of time to run (and use a considerable amount of disc space for model files) because they fit one `brms`-model per correlation coefficient.

## References

Bell, A., Fairbrother, M., & Jones, K. (2019). Fixed and random effects models: Making an informed choice. *Quality & Quantity, 53*(2), 1051–1074. https://doi.org/10/gd8wcr

Enders, C. K., & Tofighi, D. (2007). Centering predictor variables in cross-sectional multilevel models: A new look at an old issue. *Psychological Methods, 12*(2), 121–138. https://doi.org/10/b2jz57

Klingelhoefer, J., Gilbert, A., & Meier, A. (2025). Digital disconnection as a self-regulatory strategy against procrastination. *PsyArXiv*. https://doi.org/10.31234/osf.io/3j64v_v1


