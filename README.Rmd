---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mlstats <img src="man/img/sticker.png" align="right" height="138" /></a>

<!-- badges: start -->
[![R-CMD-check](https://github.com/felixdidi/mlstats/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/felixdidi/mlstats/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The **mlstats** package provides tools for conducting multilevel analyses, such as centering variables to compute random effects within-between (REWB) models or creating publication-ready descriptive tables, including within-group and between-group correlations, as well as intraclass correlation coefficients (ICCs). The package supports both frequentist (using `lme4`) and Bayesian (using `brms`) estimation methods.

## Installation

You can install the development version of mlstats from GitHub:

```r
# install.packages("pak")
pak::pak("felixdidi/mlstats")
```

## Multilevel Descriptives

### Easy Defaults

The `mldesc()` function makes it easy to compute descriptive statistics for multilevel data, including basic descriptives (mean, SD, range), within-group and between-group correlations, as well as intraclass correlation coefficients (ICCs). Let's attempt to recreate Table 1 from Klingelhoefer et al. (2024):

```{r data, echo = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
data <-
  read.csv("https://files.de-1.osf.io/v1/resources/486aq/providers/osfstorage/669e9f8b11532c02b2b35b21") |> 
  filter(compliance >= .6) |> 
  mutate(
    person = id,
    disconnective_behavior = disco_m,
    distraction_motivation = motivation_distraction,
    wellbeing_motivation = motivation_wellbeing,
    presence_motivation = motivation_presence,
    .keep = "none"
  )
```

```{r example}
library(mlstats)

vars <- c(
  "disconnective_behavior",
  "distraction_motivation",
  "wellbeing_motivation",
  "presence_motivation"
)

data |>
  mldesc(
    group = "person",
    vars = vars
  )
```

### Customizable Options

The `mldesc()` function offers several options to customize the output:

- **Weight by group size**: By default, `mldesc()` weights the group means, standard deviations, and between-group correlations by group size. This can be disabled by setting `weight = FALSE` (e.g., so that each person in the sample contributes equally to the overall mean and the between-person correlations).
- **Remove leading zeros**: By default, `mldesc()` removes leading zeros from decimal numbers to comply with APA formatting guidelines. This can be disabled by setting `remove_leading_zero = FALSE`.
- **Flip correlation matrix**: By default, `mldesc()` displays within-group correlations above the diagonal and between-group correlations below the diagonal. This can be changed by setting `flip = TRUE`.

```{r no-weight-example}
data |>
  mldesc(
    group = "person",
    vars = vars,
    weight = FALSE,
    remove_leading_zero = FALSE,
    flip = TRUE
  )
```


### Pretty Printing

The `mldesc()`-function also supports various print-methods to create nicely formatted tables that look great in your Quarto document and can be directly copied into a manuscript. Whereas the default print method outputs the table to the console, `gt` and `tinytable` outputs are also supported by setting the respective `format` option. In addition, users can provide a custom table title via the `table_title` parameter, as well as custom `correlation_note` and `note_text`.

```{r gt-example, eval = FALSE}
data |>
  mldesc(
    group = "person",
    vars = vars
  ) |> 
  print(
    format = "gt", # "tt" for tinytable
    table_title = "Descriptive statistics, within- and between-person correlations of digital disconnection and motivations",
    correlation_note = "Within-person correlations are displayed above the diagonal, between-person correlations below the diagonal.",
    note_text = NULL
  )
```

```{r gt-example-rendered, echo = FALSE, message = FALSE}
data |>
  mldesc(
    group = "person",
    vars = vars
  ) |>
  print(
    format = "gt",
    table_title = "Descriptive statistics, within- and between-person correlations of digital disconnection and motivations",
    correlation_note = "Within-person correlations are displayed above the diagonal, between-person correlations below the diagonal.",
    note_text = NULL
  ) |>
  gt::gtsave("man/img/gt-example.png")
```

![](man/img/gt-example.png)

### Pipe-Friendly Output

Although the main purpose of the package is to enable user-friendly creation of publication-ready tables, the output of both `mldesc()` and the underlying `within_between_correlations()` are tibbles with vectors of class `mlstats_stat` (or short, `mls`). These tibbles can be used for subsequent calculations by casting the contents to useful types such as `numeric` (this will remove significance stars and other formatting). For example, the output of `within_between_correlations()` can be used to identify the largest within-person correlation in the dataset:

```{r extract-example, warning = FALSE}
cors <-
  data |>
  within_between_correlations(
    group = "person",
    vars = vars
  )

cors |>
  mutate(across(-variable, as.numeric)) |> 
  rename_with(~ cors$variable, .cols = -variable) |>
  pivot_longer(-variable) |>
  rename(v1 = variable, v2 = name) |>
  group_by(v1) |>
  mutate(type = if_else(row_number() > which(is.na(value)), "wp", "bp")) |>
  ungroup() |>
  filter(type == "wp") |> 
  filter(value == max(value))
```

## Centering

The package also facilitates centering of variables for further use with the `decompose_within_between()` function. This centering approach is commonly used in multilevel modeling to separate within-group and between-group variance components (Enders & Tofighi, 2007). The decomposed variables are particularly useful for Random Effects Within-Between (REWB) models (Bell et al., 2019), which allow the estimation of distinct within-group and between-group effects.

```{r decompose-example}
data |>
  rename(disco = disconnective_behavior) |>
  decompose_within_between(
    group = "person",
    vars = "disco"
  ) |>
  select(person, matches("disco"))
```

## Bayesian Estimation

If desired, the package also supports Bayesian estimation via `brms`, providing credible intervals instead of *p*-values through `bayes_mldesc()` and `bayes_within_between_correlations()`. In addition to the parameters available in the frequentist functions, users must specify the credible interval width (`ci`) and a folder to save the fitted models (`folder`).

Note that the Bayesian functions may take a considerable amount of time to run (and use a considerable amount of disc space for model files) because they fit one `brms`-model per correlation coefficient.

## References

Bell, A., Fairbrother, M., & Jones, K. (2019). Fixed and random effects models: Making an informed choice. *Quality & Quantity, 53*(2), 1051–1074. https://doi.org/10/gd8wcr

Enders, C. K., & Tofighi, D. (2007). Centering predictor variables in cross-sectional multilevel models: A new look at an old issue. *Psychological Methods, 12*(2), 121–138. https://doi.org/10/b2jz57

Klingelhoefer, J., Gilbert, A., & Meier, A. (2024). Momentary motivations for digital disconnection: An experience sampling study. *Journal of Computer-Mediated Communication, 29*(5), zmae013. https://doi.org/10/hbb5gx

